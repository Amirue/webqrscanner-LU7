<script>
  let video = null;
  let canvas = null;
  let gCtx = null;
  let imageData = null;
  let qrProcessed = false; // Flag to prevent multiple scans
  let qrScanned = false; // Track if any QR code was scanned

  function load() {
      video = document.createElement("video");
      canvas = document.getElementById("qr-canvas");
      gCtx = canvas.getContext("2d");

      navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "user" } } })
      .then(function(stream) {
          video.srcObject = stream;
          video.setAttribute("playsinline", true); // Required to tell iOS Safari to not go fullscreen
          video.play();
          requestAnimationFrame(tick);
      }).catch(function(err) {
          console.error("Error accessing webcam: ", err);
      });
  }

  function tick() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          gCtx.drawImage(video, 0, 0, canvas.width, canvas.height);

          imageData = gCtx.getImageData(0, 0, canvas.width, canvas.height);
          let code = jsQR(imageData.data, canvas.width, canvas.height);

          if (code && !qrProcessed) { // Check if QR has not been processed
              qrProcessed = true; // Set the flag to prevent further scanning
              qrScanned = true;  // Mark that a QR code was scanned
              read(code.data);
          } else if (!code && qrScanned) {
              // Do nothing when there's no code found, only reset if we processed something
              console.log("No QR code detected");
          }
      }
      requestAnimationFrame(tick);
  }

  function read(data) {
      const checkInURL = "https://launch.investmalaysia.gov.my/check-in";
      
      // Check if the scanned data is a valid check-in URL
      if (data.startsWith(checkInURL)) {
          // Auto open the valid check-in URL
          window.open(data, "_blank");
      } else {
          // Show popup for invalid QR
          showPopup();
      }

      setTimeout(() => {
          qrProcessed = false; // Reset the flag after a delay
          qrScanned = false;   // Reset that a QR code was scanned
      }, 3000); // Allow re-scanning after 3 seconds
  }

  function showPopup() {
      const popup = document.getElementById("popup");
      popup.classList.add("show");
      setTimeout(() => {
          popup.classList.remove("show");
      }, 3000); // Auto close popup after 3 seconds
  }
</script>
